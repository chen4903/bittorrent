# Bittorrent协议

## 简介

维基百科中的定义：**BitTorrent协议**（简称**BT**，俗称**比特洪流**、**BT下载**）是用在对等网络中文件分享文件分享)的网络协议程序。和点对点（point-to-point）的协议程序不同，它是用户群对用户群（peer-to-peer），而且用户越多，下载同一文件的人越多，下载该文件的速度越快。且下载后，继续维持上传的状态，就可以“分享”，成为其用户端节点下载的种子文件（.torrent），同时上传及下载。[协议规范](https://www.bittorrent.org/beps/bep_0003.html)  [动图演示](https://upload.wikimedia.org/wikipedia/commons/3/3d/Torrentcomp_small.gif)

BitTorrent 是一种互联网点对点文件共享协议，以一种去中心化的方式工作。它的独特之处在于，当您从最初共享文件的人那里下载部分文件时，您还可以从其他下载者那里获得部分文件，以最大限度地进行数据交换。

BitTorrent 是传输超大文件最常用的协议之一，因为它不会使提供下载的 Web 服务器过载——因为每个人都在发送和接收，所以它比每个人从单个服务器下载要高效得多。

## 原理简述

普通的HTTP／FTP下载使用TCP/IP协议，BitTorrent协议是架构于TCP/IP协议之上的一个P2P文件传输通信协议，处于TCP/IP结构的应用层。BitTorrent协议本身也包含了很多具体的内容协议和扩展协议，并在不断扩展中。

根据BitTorrent协议，文件发布者会根据要发布的文件生成提供一个.torrent文件，即种子文件，也简称为“种子”。

种子文件本质上是文本文件，包含Tracker信息和文件信息两部分。Tracker信息主要是BT下载中需要用到的Tracker服务器的地址和针对Tracker服务器的设置，文件信息是根据对目标文件的计算生成的，计算结果根据BitTorrent协议内的Bencode规则进行编码。它的主要原理是需要把提供下载的文件虚拟分成大小相等的块，块大小必须为2k的整数次方（由于是虚拟分块，硬盘上并不产生各个块文件），并把每个块的索引信息和Hash验证码写入种子文件中；所以，种子文件就是被下载文件的“索引”。

下载者要下载文件内容，需要先得到相应的种子文件，然后使用BT客户端软件进行下载。

下载时，BT客户端首先解析种子文件得到Tracker地址，然后连接Tracker服务器。Tracker服务器回应下载者的请求，把其他下载者（包括发布者）的IP提供下载者。下载者再连接其他下载者，根据种子文件，两者分别告知对方自己已经有的块，然后交换对方所没有的数据。此时不需要其他服务器参与，分散了单个线路上的数据流量，因此减轻了服务器负担。

下载者每得到一个块，需要算出下载块的Hash验证码与种子文件中的对比，如果一样则说明块正确，不一样则需要重新下载这个块。这种规定是为了解决下载内容准确性的问题。

一般的HTTP/FTP下载，发布文件仅在某个或某几个服务器，下载的人太多，服务器的带宽很易不胜负荷，变得很慢。而BitTorrent协议下载的特点是，下载的人越多，提供的带宽也越多，下载速度就越快。同时，拥有完整文件的用户也会越来越多，使文件的“寿命”不断延长。

为了解决某些用户“下完就跑”的现象，在非官方BitTorrent协议中还存在一种慢慢开放下载内容的超级种子的算法。

## 种子文件

BitTorrent协议的**种子文件**（英语：Torrent file）是由BitTorrent协议所定义的，用于可以保存一组文件元数据的文件。扩展名一般为“.torrent”。标准：

[BEP-0003]: https://web.archive.org/web/20140208002821/http://bittorrent.org/beps/bep_0003.html	"标准"

种子文件包含以下数据：

- `announce` - tracker的URL

- info

  \- 该条映射到一个字典，该字典的键将取决于共享的一个或多个文件：

  - `name` - 建议保存到的文件和目录名称

  - `piece length` - 每个文件块的字节数。通常为{\displaystyle 2^{8}}![2^{{8}}](https://wikimedia.org/api/rest_v1/media/math/render/svg/b061b2d259bfa20a0ca0f7bb679f4cc366aacdd0) = 256KiB = 262144B

  - `pieces` - 每个文件块的SHA-1的集成Hash。因为SHA-1会返回160-bit的Hash，所以`pieces`将会得到1个160-bit的整数倍的字符串。和一个`length`（相当于只有一个文件正在共享）或`files`（相当于当多个文件被共享）：

  - `length` - 文件的大小（以字节为单位）

  - files

    \- 一个字典的列表（每个字典对应一个文件）与以下的键：

    - `path` - 一个对应子目录名的字符串列表，最后一项是实际的文件名称
    - `length` - 文件的大小（以字节为单位）

## Bencode

**Bencode**（发音为Bee-Encode）是BitTorrent用在传输数据结构的编码方式。这种编码方式支持四种资料类型：

- 字符串
- 整数
- 串列(列表)
- 字典表（映射）

Bencode最常被用在.torrent档中，文件里的元数据都是被Bencode编码过的字典表。这种编码方法也被tracker返回响应时使用。

虽然比用纯二进制编码效率低，但Bencode结构简单而且不受字节存储顺序影响（所有数字以十进制编码），这对于跨平台性非常重要。并且，Bencode具有较好的灵活性，即使存在故障的字典键，只要将其忽略并更换新的就能兼容补充。

### 编码方法

**Bencode**使用ASCII字符进行编码。

- 一个**整型数**会以十进制数编码并括在i和e之间，不允许前导零（但0依然为整数0），负数如十进制表示一样使用前导负号，不允许负零。如整型数“42”编码为“`i42e`”，数字“0”编码为“`i0e`”，“-42”编码为“`i-42e`”。
- 一个以字节为单位表示的**字符串**（字符串的字为一个字节，不一定是一个字符）会以`（长度）:（内容）`编码，长度的值和数字编码方法一样，只是不允许负数；内容就是字符串的内容，如字符串“spam”就会编码为“`4:spam`”，本规则不能处理ASCII以外的字符串，为了解决这个问题，一些BitTorrent程序会以非标准的方式将ASCII以外的字符以UTF-8编码转化后再编码。
- **线性表**会以l和e括住来编码，其中的内容为Bencode四种编码格式所组成的编码字符串，如包含和字符串“spam”数字“42”的线性表会被编码为“`l4:spami42ee`”，注意分隔符要对应配对。（注意：是第一个符号是小写的L，而不是14）
- **字典表**会以d和e括住来编码，字典元素的键和值必须紧跟在一起，而且所有键为字符串类型并按字典顺序排好。如键为“bar”值为字符串“spam”和键为“foo”值为整数“42”的字典表会被编码为“`d3:bar4:spam3:fooi42ee`”。

对于线性表和字典的取值范围并没有限制，它们通常会包含其他元素，这样就允许对很复杂的数据结构进行编码。

